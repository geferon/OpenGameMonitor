<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup Condition="'$(Platform)|$(ApplicationType)|$(ApplicationTypeRevision)' == 'Win32|Windows Store|10.0'">
    <OpenConsoleTppVcpkgEnabled Condition="'$(OpenConsoleTppVcpkgEnabled)' == ''">true</OpenConsoleTppVcpkgEnabled>
    <OpenConsoleTppVcpkgTriplet Condition="'$(OpenConsoleTppVcpkgTriplet)' == ''">x86-uwp-mixed</OpenConsoleTppVcpkgTriplet>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Platform)|$(ApplicationType)|$(ApplicationTypeRevision)' == 'x64|Windows Store|10.0'">
    <OpenConsoleTppVcpkgEnabled Condition="'$(OpenConsoleTppVcpkgEnabled)' == ''">true</OpenConsoleTppVcpkgEnabled>
    <OpenConsoleTppVcpkgTriplet Condition="'$(OpenConsoleTppVcpkgTriplet)' == ''">x64-uwp-mixed</OpenConsoleTppVcpkgTriplet>
  </PropertyGroup>

  <PropertyGroup Condition="'$(Platform)|$(ApplicationType)|$(ApplicationTypeRevision)' == 'arm64|Windows Store|10.0'">
    <OpenConsoleTppVcpkgEnabled Condition="'$(OpenConsoleTppVcpkgEnabled)' == ''">true</OpenConsoleTppVcpkgEnabled>
    <OpenConsoleTppVcpkgTriplet Condition="'$(OpenConsoleTppVcpkgTriplet)' == ''">arm64-uwp-mixed</OpenConsoleTppVcpkgTriplet>
  </PropertyGroup>

  <PropertyGroup Condition="'$(OpenConsoleTppVcpkgEnabled)' == 'true'">
    <OpenConsoleTppVcpkgConfiguration Condition="'$(OpenConsoleTppVcpkgConfiguration)' == ''">$(Configuration)</OpenConsoleTppVcpkgConfiguration>
    <OpenConsoleTppVcpkgNormalizedConfiguration Condition="$(OpenConsoleTppVcpkgConfiguration.StartsWith('Debug'))">Debug</OpenConsoleTppVcpkgNormalizedConfiguration>
    <OpenConsoleTppVcpkgNormalizedConfiguration Condition="$(OpenConsoleTppVcpkgConfiguration.StartsWith('Release')) or '$(OpenConsoleTppVcpkgConfiguration)' == 'RelWithDebInfo' or '$(OpenConsoleTppVcpkgConfiguration)' == 'MinSizeRel'">Release</OpenConsoleTppVcpkgNormalizedConfiguration>
    <OpenConsoleTppVcpkgRoot Condition="'$(OpenConsoleTppVcpkgRoot)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), .vcpkg-root))\installed\$(OpenConsoleTppVcpkgTriplet)\</OpenConsoleTppVcpkgRoot>
    <OpenConsoleTppVcpkgCommonRoot Condition="'$(OpenConsoleTppVcpkgCommonRoot)' == ''">$([MSBuild]::GetDirectoryNameOfFileAbove($(MSBuildThisFileDirectory), .vcpkg-root))\installed\common\</OpenConsoleTppVcpkgCommonRoot>
    <OpenConsoleTppVcpkgApplocalDeps Condition="'$(OpenConsoleTppVcpkgApplocalDeps)' == ''">true</OpenConsoleTppVcpkgApplocalDeps>
    <!-- Deactivate Autolinking if lld is used as a linker. (Until a better way to solve the problem is found!). 
    Tried to add /lib as a parameter to the linker call but was unable to find a way to pass it as the first parameter. -->
    <OpenConsoleTppVcpkgAutoLink Condition="'$(UseLldLink)' == 'true' and '$(OpenConsoleTppVcpkgAutoLink)' == ''">false</OpenConsoleTppVcpkgAutoLink>
  </PropertyGroup>

  <ItemDefinitionGroup Condition="'$(OpenConsoleTppVcpkgEnabled)' == 'true'">
    <Link>
      <AdditionalDependencies Condition="'$(OpenConsoleTppVcpkgNormalizedConfiguration)' == 'Debug' and '$(OpenConsoleTppVcpkgAutoLink)' != 'false'">%(AdditionalDependencies);$(OpenConsoleTppVcpkgRoot)debug\lib\*.lib</AdditionalDependencies>
      <AdditionalDependencies Condition="'$(OpenConsoleTppVcpkgNormalizedConfiguration)' == 'Release' and '$(OpenConsoleTppVcpkgAutoLink)' != 'false'">%(AdditionalDependencies);$(OpenConsoleTppVcpkgRoot)lib\*.lib</AdditionalDependencies>
      <AdditionalLibraryDirectories Condition="'$(OpenConsoleTppVcpkgNormalizedConfiguration)' == 'Release'">%(AdditionalLibraryDirectories);$(OpenConsoleTppVcpkgRoot)lib;$(OpenConsoleTppVcpkgRoot)lib\manual-link</AdditionalLibraryDirectories>
      <AdditionalLibraryDirectories Condition="'$(OpenConsoleTppVcpkgNormalizedConfiguration)' == 'Debug'">%(AdditionalLibraryDirectories);$(OpenConsoleTppVcpkgRoot)debug\lib;$(OpenConsoleTppVcpkgRoot)debug\lib\manual-link</AdditionalLibraryDirectories>
    </Link>
    <ClCompile>
      <AdditionalIncludeDirectories>%(AdditionalIncludeDirectories);$(OpenConsoleTppVcpkgCommonRoot)include</AdditionalIncludeDirectories>
    </ClCompile>
    <ResourceCompile>
      <AdditionalIncludeDirectories>%(AdditionalIncludeDirectories);$(OpenConsoleTppVcpkgCommonRoot)include</AdditionalIncludeDirectories>
    </ResourceCompile>
  </ItemDefinitionGroup>

  <Target Name="OpenConsoleTppVcpkgTripletSelection" BeforeTargets="ClCompile">
    <Message Text="Using triplet &quot;$(OpenConsoleTppVcpkgTriplet)&quot; from &quot;$(OpenConsoleTppVcpkgRoot)&quot;" Importance="Normal" Condition="'$(OpenConsoleTppVcpkgEnabled)' == 'true'"/>
    <Message Text="Not using OpenConsoleTppVcpkg because OpenConsoleTppVcpkgEnabled is &quot;$(OpenConsoleTppVcpkgEnabled)&quot;" Importance="Normal" Condition="'$(OpenConsoleTppVcpkgEnabled)' != 'true'"/>
    <Message Text="OpenConsoleTppVcpkg is unable to link because we cannot decide between Release and Debug libraries. Please define the property OpenConsoleTppVcpkgConfiguration to be 'Release' or 'Debug' (currently '$(OpenConsoleTppVcpkgConfiguration)')." Importance="High" Condition="'$(OpenConsoleTppVcpkgEnabled)' == 'true' and '$(OpenConsoleTppVcpkgNormalizedConfiguration)' == ''"/>
  </Target>

  <Target Name="OpenConsoleTppAppLocalFromInstalled" AfterTargets="CopyFilesToOutputDirectory" BeforeTargets="CopyLocalFilesOutputGroup;RegisterOutput" Condition="'$(OpenConsoleTppVcpkgEnabled)' == 'true' and '$(OpenConsoleTppVcpkgApplocalDeps)' == 'true'">
    <WriteLinesToFile
    File="$(TLogLocation)$(ProjectName).write.1u.tlog"
    Lines="^$(TargetPath);$([System.IO.Path]::Combine($(ProjectDir),$(IntDir)))tppvcpkg.applocal.log" Encoding="Unicode"/>
    <Exec Condition="$(OpenConsoleTppVcpkgConfiguration.StartsWith('Debug'))"
      Command="$(SystemRoot)\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -noprofile -File %22$(MSBuildThisFileDirectory)applocal.ps1%22 %22$(TargetPath)%22 %22$(OpenConsoleTppVcpkgRoot)debug\bin%22 %22$(TLogLocation)$(ProjectName).write.1u.tlog%22 %22$(IntDir)tppvcpkg.applocal.log%22"
      StandardOutputImportance="Normal">
    </Exec>
    <Exec Condition="$(OpenConsoleTppVcpkgConfiguration.StartsWith('Release'))"
      Command="$(SystemRoot)\System32\WindowsPowerShell\v1.0\powershell.exe -ExecutionPolicy Bypass -noprofile -File %22$(MSBuildThisFileDirectory)applocal.ps1%22 %22$(TargetPath)%22 %22$(OpenConsoleTppVcpkgRoot)bin%22 %22$(TLogLocation)$(ProjectName).write.1u.tlog%22 %22$(IntDir)tppvcpkg.applocal.log%22"
      StandardOutputImportance="Normal">
    </Exec>
    <ReadLinesFromFile File="$(IntDir)tppvcpkg.applocal.log">
      <Output TaskParameter="Lines" ItemName="OpenConsoleTppVcpkgAppLocalDLLs" />
    </ReadLinesFromFile>
    <Message Text="@(OpenConsoleTppVcpkgAppLocalDLLs,'%0A')" Importance="Normal" />
    <ItemGroup>
      <ReferenceCopyLocalPaths Include="@(OpenConsoleTppVcpkgAppLocalDLLs)" />
    </ItemGroup>
  </Target>
</Project>
